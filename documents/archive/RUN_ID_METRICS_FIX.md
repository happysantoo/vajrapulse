# Run ID in Metrics - Implementation Fix

**Date**: November 16, 2025  
**Issue**: run_id not visible in Grafana metrics  
**Status**: ‚úÖ FIXED

## Problem

When running load tests with OpenTelemetry exporter, the `run_id` was not appearing as a filterable label in Grafana, making it difficult to correlate metrics from different test runs.

### Root Cause

The `run_id` was being added to the `MetricsCollector` (Micrometer registry) but was **not** being passed through to the OpenTelemetry exporter's metric attributes. The OpenTelemetryExporter was creating metrics independently without reading tags from the Micrometer registry.

**Flow Before Fix**:
```
MetricsPipeline.withRunId() 
  ‚Üí MetricsCollector.createWithRunId() (adds run_id as Micrometer tag)
  ‚Üí OpenTelemetryExporter (NO run_id - creates own metrics)
  ‚Üí OTLP/Prometheus/Grafana (NO run_id label visible)
```

## Solution

Added `run_id` support to `OpenTelemetryExporter` with **automatic UUID generation** when not explicitly set:

### 1. Auto-Generated Run ID
- **If not provided**: Automatically generates a random UUID
- **If provided**: Uses the specified run_id
- **Always present**: Every test run has a unique identifier

### 2. Resource Attribute (run.id)
- Added as a resource attribute for service-level correlation
- Follows OpenTelemetry semantic conventions
- Useful for distributed tracing correlation

### 3. Metric Attribute (run_id) ‚ú® **Key Fix**
- Added to ALL metrics as a data point attribute
- Makes `run_id` filterable in Grafana queries
- Applied to:
  - `vajrapulse.execution.count` (success/failure counters)
  - `vajrapulse.execution.duration` (percentile gauges)
  - `vajrapulse.success.rate` (success rate gauge)

**Flow After Fix**:
```
MetricsPipeline.withRunId() 
  ‚Üí MetricsCollector.createWithRunId() (run_id in Micrometer)
  ‚Üí OpenTelemetryExporter.runId() (run_id set in exporter builder)
  ‚Üí Metrics exported with run_id attribute
  ‚Üí OTLP/Prometheus/Grafana (run_id appears as label) ‚úÖ
```

## Changes Made

### 1. OpenTelemetryExporter.java

**Added field**:
```java
private final String runId;
```

**Auto-generate UUID if not provided**:
```java
// In constructor
this.runId = (builder.runId != null && !builder.runId.isBlank()) 
    ? builder.runId 
    : java.util.UUID.randomUUID().toString();
```

**Added builder method**:
```java
public Builder runId(String runId) {
    this.runId = runId;
    return this;
}
```

**Added getter method**:
```java
public String getRunId() {
    return runId;  // Never null, always set (user-provided or UUID)
}
```

**Added to resource attributes**:
```java
// Always present (auto-generated UUID if not provided)
attributesBuilder.put(AttributeKey.stringKey("run.id"), runId);
```

**Added to execution count metrics**:
```java
if (deltaSuccess > 0) {
    executionCount.add(deltaSuccess, Attributes.builder()
        .put(AttributeKey.stringKey("status"), "success")
        .put(AttributeKey.stringKey("run_id"), runId)  // Always present
        .build());
}
```

**Added to duration percentile gauges**:
```java
measurement.record(ms, Attributes.builder()
    .put(AttributeKey.stringKey("status"), "success")
    .put(AttributeKey.stringKey("percentile"), p)
    .put(AttributeKey.stringKey("run_id"), runId)  // Always present
    .build());
```

**Added to success rate gauge**:
```java
measurement.record(snapshot.successRate(), 
    Attributes.of(AttributeKey.stringKey("run_id"), runId));  // Always present
```

### 2. HttpLoadTestOtelRunner.java (Example Update)

**Simplified - runId auto-generated by default**:
```java
OpenTelemetryExporter otelExporter = OpenTelemetryExporter.builder()
    .endpoint("http://localhost:4317")
    .protocol(Protocol.GRPC)
    // runId is optional - auto-generated UUID if not set
    // .runId("custom-run-id")
    .taskIdentity(identity)
    .resourceAttributes(...)
    .build();

// Get the auto-generated or user-provided run_id
String runId = otelExporter.getRunId();
```

**Display auto-generated run ID**:
```java
System.out.println("  Run ID:       " + otelExporter.getRunId());
```

**Pass to MetricsPipeline**:
```java
MetricsPipeline pipeline = MetricsPipeline.builder()
    .addExporter(otelExporter)
    .withRunId(otelExporter.getRunId())  // Use same run_id
    .build();
```

## Usage

### Option 1: Auto-Generated UUID (Simplest)

```java
OpenTelemetryExporter exporter = OpenTelemetryExporter.builder()
    .endpoint("http://localhost:4317")
    .build();  // run_id auto-generated as UUID

String runId = exporter.getRunId();  // Get the auto-generated UUID

MetricsPipeline pipeline = MetricsPipeline.builder()
    .addExporter(exporter)
    .withRunId(runId)  // Use same run_id
    .build();

pipeline.run(task, loadPattern);
```

### Option 2: Custom Run ID

```java
String customRunId = "load-test-" + System.currentTimeMillis();

OpenTelemetryExporter exporter = OpenTelemetryExporter.builder()
    .endpoint("http://localhost:4317")
    .runId(customRunId)  // Set custom run ID
    .build();

MetricsPipeline pipeline = MetricsPipeline.builder()
    .addExporter(exporter)
    .withRunId(customRunId)  // Use same custom run ID
    .build();

pipeline.run(task, loadPattern);
```

### Grafana Query Examples

Now you can filter by `run_id` in Grafana (every run has a unique run_id):

```promql
# Filter by specific run (auto-generated UUID)
vajrapulse_execution_count{run_id="a1b2c3d4-e5f6-7890-abcd-ef1234567890"}

# Filter by custom run_id pattern
vajrapulse_execution_count{run_id=~"load-test-.*"}

# Compare multiple runs
vajrapulse_execution_duration{percentile="0.95", run_id=~".*"}

# Success rate for specific run
vajrapulse_success_rate{run_id="a1b2c3d4-e5f6-7890-abcd-ef1234567890"}
```

### OpenTelemetry Collector

The `run_id` will appear in OTLP metrics as:
- **Resource attribute**: `run.id` (service-level)
- **Data point attribute**: `run_id` (metric-level) ‚ú®

Example OTLP metric:
```json
{
  "resourceMetrics": [{
    "resource": {
      "attributes": [
        {"key": "run.id", "value": {"stringValue": "http-test-1731753600000"}},
        {"key": "service.name", "value": {"stringValue": "vajrapulse-http-example"}}
      ]
    },
    "scopeMetrics": [{
      "metrics": [{
        "name": "vajrapulse.execution.count",
        "sum": {
          "dataPoints": [{
            "attributes": [
              {"key": "status", "value": {"stringValue": "success"}},
              {"key": "run_id", "value": {"stringValue": "http-test-1731753600000"}}
            ],
            "asInt": "3000"
          }]
        }
      }]
    }]
  }]
}
```

## Testing

### Build Verification
```bash
./gradlew :vajrapulse-exporter-opentelemetry:build
# BUILD SUCCESSFUL

./gradlew :examples:http-load-test:build
# BUILD SUCCESSFUL
```

### Manual Test
```bash
# Start observability stack
cd examples/http-load-test
docker compose up -d

# Run load test
cd ../..
./gradlew :examples:http-load-test:runOtel

# Check Grafana (http://localhost:3000)
# Query: vajrapulse_execution_count
# Should see run_id label in metric labels
```

### Expected Output in Grafana

**Before Fix**:
```
vajrapulse_execution_count{status="success"}
```
‚ùå No `run_id` label

**After Fix**:
```
vajrapulse_execution_count{run_id="a1b2c3d4-e5f6-7890-abcd-ef1234567890", status="success"}
```
‚úÖ `run_id` label visible and filterable (auto-generated UUID)

**With Custom Run ID**:
```
vajrapulse_execution_count{run_id="load-test-1731753600000", status="success"}
```
‚úÖ `run_id` label with custom value

## Benefits

1. **Run Correlation**: Easily filter metrics by specific test run
2. **Historical Comparison**: Compare metrics across different runs
3. **Debugging**: Identify which run produced specific metrics
4. **Tracing Integration**: Correlate metrics with distributed traces using same run_id
5. **Multi-tenant**: Support multiple concurrent load tests with unique run IDs

## Backwards Compatibility

‚úÖ **Fully backwards compatible**

- `run_id` parameter is **optional** in `OpenTelemetryExporter.Builder`
- If not provided, **automatically generates a UUID** (always present in metrics)
- If provided, uses the custom value
- Existing code continues to work without changes
- `getRunId()` method always returns a non-null value

## Next Steps

### Recommended Enhancements

1. ~~**Auto-generate run_id**: MetricsPipeline could auto-generate if not provided~~ ‚úÖ **DONE**
2. **CLI support**: Add `--run-id` flag to worker CLI
3. **Environment variable**: Support `VAJRAPULSE_RUN_ID` env var
4. **Grafana dashboard**: Create example dashboard with run_id filter
5. **Documentation**: Update user guide with run_id best practices

### Verification Checklist

- [x] Code compiles successfully
- [x] Tests pass
- [x] Example updated to demonstrate usage
- [x] run_id appears as resource attribute (run.id)
- [x] run_id appears as metric attribute (run_id)
- [x] run_id auto-generated as UUID if not provided
- [x] getRunId() method returns the run_id (never null)
- [ ] Manual verification in Grafana (requires running test)
- [ ] Update Grafana dashboard examples
- [ ] Update user documentation

## Summary

The `run_id` is now fully propagated through the metrics pipeline:

**MetricsPipeline ‚Üí MetricsCollector ‚Üí OpenTelemetryExporter ‚Üí OTLP ‚Üí Prometheus ‚Üí Grafana**

All metrics exported via OpenTelemetry now include `run_id` as a filterable label, enabling:
- Single-run filtering
- Multi-run comparison
- Distributed tracing correlation
- Historical analysis

**Impact**: Users can now easily identify and filter metrics by test run in Grafana! üéâ
